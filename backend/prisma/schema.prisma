generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Initial minimal schema; will expand later
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  passwordHash String
  baseCurrency String   @default("USD")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  accounts    Account[]
  trades      Trade[]
  tags        Tag[]
  settings    UserSettings?
  strategies  Strategy[]
}

model UserSettings {
  id          String  @id @default(cuid())
  user        User    @relation(fields: [userId], references: [id])
  userId      String  @unique
  favoriteAccountId String?
  defaultTagId String?
  defaultChartInterval String? // e.g. '1d','1h','15m'
  defaultChartWindowDays Int?  // e.g. 5,15,30,90
  theme       String? // UI theme key, e.g. 'aurora' | 'solar' | 'emerald' | 'amethyst' | 'ocean' | 'mono'
}

model Account {
  id        String    @id @default(cuid())
  user      User      @relation(fields: [userId], references: [id])
  userId    String
  name      String
  currency  String    @default("USD")
  defaultFeePerMiniContract  Decimal? @db.Decimal(18,2)
  defaultFeePerMicroContract Decimal? @db.Decimal(18,2)
  createdAt DateTime  @default(now())
  trades    Trade[]
  transactions Transaction[]
  fees       AccountFee[]
  tickerFees TickerFee[]
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
}

model Transaction {
  id        String   @id @default(cuid())
  account   Account  @relation(fields: [accountId], references: [id])
  accountId String
  type      TransactionType
  amount    Decimal  @db.Decimal(18,2)
  currency  String
  createdAt DateTime @default(now())
}

enum AssetClass {
  STOCK
  OPTION
  FUTURE
  FOREX
  CRYPTO
}

enum FeeMode {
  PER_CONTRACT_DOLLAR
  PER_CONTRACT_PERCENT
}

model AccountFee {
  id         String    @id @default(cuid())
  account    Account   @relation(fields: [accountId], references: [id])
  accountId  String
  assetClass AssetClass
  mode       FeeMode
  value      Decimal   @db.Decimal(18,6)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  @@unique([accountId, assetClass])
}

model TickerFee {
  id         String   @id @default(cuid())
  account    Account  @relation(fields: [accountId], references: [id])
  accountId  String
  symbol     String
  mode       FeeMode
  value      Decimal  @db.Decimal(18,6)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  @@unique([accountId, symbol])
}

model Trade {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id])
  userId      String
  account     Account   @relation(fields: [accountId], references: [id])
  accountId   String
  symbol      String
  assetClass  AssetClass
  direction   TradeDirection? // LONG or SHORT; null for legacy trades until set
  strategy    String? // legacy freeform
  strategyRef Strategy? @relation(fields: [strategyId], references: [id])
  strategyId  String? // legacy single relation (will migrate to TradeStrategy join)
  size        Decimal   @db.Decimal(18,4)
  entryPrice  Decimal   @db.Decimal(18,6)
  exitPrice   Decimal?  @db.Decimal(18,6)
  entryTime   DateTime
  exitTime    DateTime?
  stopPrice   Decimal?  @db.Decimal(18,6)
  targetPrice Decimal?  @db.Decimal(18,6)
  fees        Decimal?  @db.Decimal(18,2)
  notes       String?
  confidence  Int?      // 0-100
  attachments Attachment[]
  tradeTags   TradeTag[]
  tradeFills  TradeFill[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
}

model Strategy {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  name        String
  description String?
  active      Boolean  @default(true)
  trades      Trade[]
  tags        StrategyTag[]
  category    String?
  riskProfile String?
  playbookMarkdown String?
  archivedAt DateTime?
  version     Int      @default(1)
  tradeLinks  TradeStrategy[]
  versions    StrategyVersion[]
  tagTemplates StrategyTagTemplate[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@unique([userId, name])
}

// Tags associated specifically with a strategy taxonomy (distinct from Trade tags)
model StrategyTag {
  id         String    @id @default(cuid())
  strategy   Strategy  @relation(fields: [strategyId], references: [id])
  strategyId String
  name       String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  @@unique([strategyId, name])
}

model TradeStrategy {
  id         String   @id @default(cuid())
  trade      Trade    @relation(fields: [tradeId], references: [id])
  tradeId    String
  strategy   Strategy @relation(fields: [strategyId], references: [id])
  strategyId String
  weight     Decimal? @db.Decimal(5,2) // percentage relevance 0-100
  createdAt  DateTime @default(now())
  @@unique([tradeId, strategyId])
}

model StrategyVersion {
  id          String   @id @default(cuid())
  strategy    Strategy @relation(fields: [strategyId], references: [id])
  strategyId  String
  number      Int
  notes       String?
  createdAt   DateTime @default(now())
  snapshots   StrategyMetricSnapshot[]
  @@unique([strategyId, number])
}

model StrategyTagTemplate {
  id          String   @id @default(cuid())
  strategy    Strategy @relation(fields: [strategyId], references: [id])
  strategyId  String
  tag         Tag      @relation(fields: [tagId], references: [id])
  tagId       String
  required    Boolean  @default(false)
  recommended Boolean  @default(false)
  createdAt   DateTime @default(now())
  @@unique([strategyId, tagId])
}

model StrategyMetricSnapshot {
  id               String   @id @default(cuid())
  strategyVersion  StrategyVersion @relation(fields: [strategyVersionId], references: [id])
  strategyVersionId String
  rangeStart       DateTime
  rangeEnd         DateTime
  pnl              Decimal  @db.Decimal(18,2)
  winRate          Decimal  @db.Decimal(5,2) // percent
  avgR             Decimal  @db.Decimal(10,4)
  breakdown        Json
  createdAt        DateTime @default(now())
  @@index([strategyVersionId])
}

enum TradeDirection {
  LONG
  SHORT
}

enum TradeFillType {
  ENTRY
  EXIT
}

model TradeFill {
  id        String       @id @default(cuid())
  trade     Trade        @relation(fields: [tradeId], references: [id])
  tradeId   String
  type      TradeFillType
  price     Decimal      @db.Decimal(18,6)
  size      Decimal      @db.Decimal(18,4)
  time      DateTime
  createdAt DateTime     @default(now())
  @@index([tradeId])
}

model Attachment {
  id       String @id @default(cuid())
  trade    Trade  @relation(fields: [tradeId], references: [id])
  tradeId  String
  url      String
  createdAt DateTime @default(now())
}

model Tag {
  id      String   @id @default(cuid())
  user    User     @relation(fields: [userId], references: [id])
  userId  String
  name    String
  type    TagType  @default(CUSTOM)
  color   String?
  description String?
  parent   Tag?     @relation("TagChildren", fields: [parentTagId], references: [id])
  parentTagId String?
  children Tag[]    @relation("TagChildren")
  archivedAt DateTime?
  trades  TradeTag[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([userId, name])
}

enum TagType {
  SETUP
  CONDITION
  MISTAKE
  MARKET
  EXECUTION
  OUTCOME
  CUSTOM
}

model TradeTag {
  id      String @id @default(cuid())
  trade   Trade  @relation(fields: [tradeId], references: [id])
  tradeId String
  tag     Tag    @relation(fields: [tagId], references: [id])
  tagId   String
  @@unique([tradeId, tagId])
}

model ExchangeRate {
  id        String   @id @default(cuid())
  date      DateTime
  base      String
  quote     String
  rate      Decimal @db.Decimal(18,8)
  @@unique([date, base, quote])
}
