generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Initial minimal schema; will expand later
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  passwordHash String
  baseCurrency String   @default("USD")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  accounts    Account[]
  trades      Trade[]
  tags        Tag[]
  settings    UserSettings?
  strategies  Strategy[]
}

model UserSettings {
  id          String  @id @default(cuid())
  user        User    @relation(fields: [userId], references: [id])
  userId      String  @unique
  favoriteAccountId String?
  defaultTagId String?
  defaultChartInterval String? // e.g. '1d','1h','15m'
  defaultChartWindowDays Int?  // e.g. 5,15,30,90
}

model Account {
  id        String    @id @default(cuid())
  user      User      @relation(fields: [userId], references: [id])
  userId    String
  name      String
  currency  String    @default("USD")
  defaultFeePerMiniContract  Decimal? @db.Decimal(18,2)
  defaultFeePerMicroContract Decimal? @db.Decimal(18,2)
  createdAt DateTime  @default(now())
  trades    Trade[]
  transactions Transaction[]
  fees       AccountFee[]
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
}

model Transaction {
  id        String   @id @default(cuid())
  account   Account  @relation(fields: [accountId], references: [id])
  accountId String
  type      TransactionType
  amount    Decimal  @db.Decimal(18,2)
  currency  String
  createdAt DateTime @default(now())
}

enum AssetClass {
  STOCK
  OPTION
  FUTURE
  FOREX
  CRYPTO
}

enum FeeMode {
  PER_CONTRACT_DOLLAR
  PER_CONTRACT_PERCENT
}

model AccountFee {
  id         String    @id @default(cuid())
  account    Account   @relation(fields: [accountId], references: [id])
  accountId  String
  assetClass AssetClass
  mode       FeeMode
  value      Decimal   @db.Decimal(18,6)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  @@unique([accountId, assetClass])
}

model Trade {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id])
  userId      String
  account     Account   @relation(fields: [accountId], references: [id])
  accountId   String
  symbol      String
  assetClass  AssetClass
  direction   TradeDirection? // LONG or SHORT; null for legacy trades until set
  strategy    String? // freeform legacy field; superseded by strategyId relation
  strategyRef Strategy? @relation(fields: [strategyId], references: [id])
  strategyId  String?
  size        Decimal   @db.Decimal(18,4)
  entryPrice  Decimal   @db.Decimal(18,6)
  exitPrice   Decimal?  @db.Decimal(18,6)
  entryTime   DateTime
  exitTime    DateTime?
  stopPrice   Decimal?  @db.Decimal(18,6)
  targetPrice Decimal?  @db.Decimal(18,6)
  fees        Decimal?  @db.Decimal(18,2)
  notes       String?
  confidence  Int?      // 0-100
  setupMode   Boolean   @default(false)
  attachments Attachment[]
  tradeTags   TradeTag[]
  tradeFills  TradeFill[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
}

model Strategy {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  name        String
  description String?
  active      Boolean  @default(true)
  checklistItems StrategyChecklistItem[]
  trades      Trade[]
  tags        StrategyTag[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@unique([userId, name])
}

model StrategyChecklistItem {
  id          String   @id @default(cuid())
  strategy    Strategy @relation(fields: [strategyId], references: [id])
  strategyId  String
  text        String
  order       Int      @default(0)
  required    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([strategyId])
}

// Tags associated specifically with a strategy taxonomy (distinct from Trade tags)
model StrategyTag {
  id         String    @id @default(cuid())
  strategy   Strategy  @relation(fields: [strategyId], references: [id])
  strategyId String
  name       String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  @@unique([strategyId, name])
}

enum TradeDirection {
  LONG
  SHORT
}

enum TradeFillType {
  ENTRY
  EXIT
}

model TradeFill {
  id        String       @id @default(cuid())
  trade     Trade        @relation(fields: [tradeId], references: [id])
  tradeId   String
  type      TradeFillType
  price     Decimal      @db.Decimal(18,6)
  size      Decimal      @db.Decimal(18,4)
  time      DateTime
  createdAt DateTime     @default(now())
  @@index([tradeId])
}

model Attachment {
  id       String @id @default(cuid())
  trade    Trade  @relation(fields: [tradeId], references: [id])
  tradeId  String
  url      String
  createdAt DateTime @default(now())
}

model Tag {
  id      String   @id @default(cuid())
  user    User     @relation(fields: [userId], references: [id])
  userId  String
  name    String
  trades  TradeTag[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([userId, name])
}

model TradeTag {
  id      String @id @default(cuid())
  trade   Trade  @relation(fields: [tradeId], references: [id])
  tradeId String
  tag     Tag    @relation(fields: [tagId], references: [id])
  tagId   String
  @@unique([tradeId, tagId])
}

model ExchangeRate {
  id        String   @id @default(cuid())
  date      DateTime
  base      String
  quote     String
  rate      Decimal @db.Decimal(18,8)
  @@unique([date, base, quote])
}
